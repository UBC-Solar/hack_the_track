
# Class to help defining mocked state to be easier, might be removed
class StatePosition(): 
    def __init__(self, x: float, y: float, time: float):
        self.x = x
        self.y = y
        self.time = time

gates = [[[-86.62010546821989, 33.53199393745435], [-86.62054692043583, 33.53220110405339]], [[-86.6202521160095, 33.53194077869568], [-86.62064688230524, 33.53207461617495]], [[-86.62034072254556, 33.53183147009808], [-86.62076547585676, 33.5320176121054]], [[-86.62043125286756, 33.53175575024494], [-86.62090180706743, 33.53187610682864]], [[-86.62056083055128, 33.53158983994967], [-86.62109887485597, 33.53177049635491]], [[-86.62074921960236, 33.53145576840601], [-86.62128695956608, 33.53162778036015]], [[-86.62097552089232, 33.53127134654161], [-86.62153484485349, 33.53137619289964]], [[-86.62120414952402, 33.53108844736688], [-86.62176708392077, 33.53121869327715]], [[-86.6214533915965, 33.53095014633386], [-86.62193791280636, 33.53107373824272]], [[-86.62160630382596, 33.53078503634045], [-86.62217080107399, 33.53100396870655]], [[-86.62176553250175, 33.53061198338192], [-86.6222598704797, 33.53093703067676]], [[-86.62200283570512, 33.53052258380786], [-86.62230978918363, 33.53086121529262]], [[-86.6222853033687, 33.53050100224739], [-86.6224500188457, 33.5308940169287]], [[-86.62261726956787, 33.53054809994213], [-86.6225470874764, 33.53097719846708]], [[-86.62283213232719, 33.53070515321068], [-86.62272413791125, 33.53104414585803]], [[-86.62301192071278, 33.53083762867756], [-86.62286842385124, 33.53126862119087]], [[-86.62313647705642, 33.53103782971986], [-86.62300322161774, 33.5314077031688]], [[-86.62337272306728, 33.5311282198633], [-86.6232740809322, 33.53150989786806]], [[-86.62355809899944, 33.5311676513267], [-86.62370535519022, 33.531574643247]], [[-86.62377788265864, 33.53109957360068], [-86.62406122550199, 33.53147979518921]], [[-86.62396987758657, 33.53087896165002], [-86.62431044228225, 33.53115108117232]], [[-86.62394729098249, 33.53054519428242], [-86.62446126657373, 33.53080478739108]], [[-86.62398143483396, 33.53034131350044], [-86.62460000854949, 33.53041923099301]], [[-86.62395444286855, 33.53012182537687], [-86.6245325220527, 33.52999268004208]], [[-86.62384448919376, 33.52995205498562], [-86.62426547399389, 33.52961442483317]], [[-86.62364096779714, 33.52984058500965], [-86.62385105528907, 33.52947931672821]], [[-86.62333134384689, 33.52974544401334], [-86.62350067998118, 33.52936763728649]], [[-86.62287231919512, 33.52974363420437], [-86.62307423000203, 33.52921412024556]], [[-86.62255517908149, 33.52962895044082], [-86.62262637067373, 33.52916228672823]], [[-86.6223320633883, 33.52958602531563], [-86.62213049323091, 33.52896748804549]], [[-86.6221421841963, 33.5296451326782], [-86.62185183130438, 33.52918610108969]], [[-86.62201895390986, 33.52974395070403], [-86.62157086648534, 33.52944323245603]], [[-86.62191733640124, 33.52998280498196], [-86.62141972655856, 33.52974912040983]], [[-86.6216494710644, 33.53030214776343], [-86.62110752894768, 33.52990701323549]], [[-86.62120569539091, 33.53047250672871], [-86.62096831778602, 33.53005100150705]], [[-86.62079919160384, 33.53058086953406], [-86.62056724247218, 33.53012719533275]], [[-86.62029316807643, 33.5307553074533], [-86.62004781862828, 33.53030821084526]], [[-86.61981731665735, 33.53078315686463], [-86.6196393516397, 33.53050606893731]], [[-86.61947771961862, 33.53100581740494], [-86.61923729429925, 33.53063003571742]], [[-86.6190146621124, 33.53117978968104], [-86.61886483065018, 33.53084347826744]], [[-86.61869249227684, 33.53134982014637], [-86.6184916175723, 33.53097645084897]], [[-86.61832228227686, 33.53144901873425], [-86.61812893338043, 33.53116414369347]], [[-86.61797129266884, 33.53159574245549], [-86.6178761560536, 33.53128007619174]], [[-86.61771352062486, 33.53172661103167], [-86.61757448634458, 33.53137136831086]], [[-86.6175136922667, 33.53188164293196], [-86.61715829328092, 33.53157816224649]], [[-86.61732971866336, 33.53203777292325], [-86.61701226471412, 33.53185907005802]], [[-86.61729049092484, 33.5322093525516], [-86.61676154882464, 33.53208301742102]], [[-86.61719140477275, 33.53248658207826], [-86.61675073009454, 33.53228092912182]], [[-86.61687882759757, 33.53273011771869], [-86.61649986901381, 33.53244944430104]], [[-86.61661865053945, 33.53297452099204], [-86.61629947186354, 33.53271617498135]], [[-86.61640567815925, 33.53314200665391], [-86.61602222891611, 33.53285688547686]], [[-86.61607166146656, 33.53337375086878], [-86.61570673922935, 33.533116761313]], [[-86.61578829416936, 33.53361950982556], [-86.61539919076681, 33.53331186737009]], [[-86.61560266090454, 33.53386084106602], [-86.61516176055746, 33.53352579662432]], [[-86.61527252958585, 33.5339992736489], [-86.6148775371729, 33.53366418151067]], [[-86.6150348029417, 33.53427203203855], [-86.61464159668564, 33.53399695835937]], [[-86.61488383197707, 33.53441132334868], [-86.61441052994394, 33.53427916945088]], [[-86.61481604942263, 33.53455816939549], [-86.61436748909242, 33.53476504083605]], [[-86.6148217474621, 33.53462914700814], [-86.61472909462837, 33.53505030440418]], [[-86.6149363805315, 33.53467749252585], [-86.61510733910742, 33.5350420211544]], [[-86.61514764538487, 33.5345844017486], [-86.61532186853023, 33.5349488004741]], [[-86.61549535962202, 33.53455833646458], [-86.615513424236, 33.53491699209501]], [[-86.61572030593013, 33.53456001021294], [-86.61581528304905, 33.5349549255229]], [[-86.61587034612005, 33.5344510345249], [-86.61609765951002, 33.53484427583977]], [[-86.61602420326497, 33.53435718669588], [-86.61633335065682, 33.5346337764574]], [[-86.61614617831876, 33.534156632463], [-86.61661451798146, 33.53439876062306]], [[-86.61625981205255, 33.53387669599562], [-86.61677626445115, 33.5341649020347]], [[-86.61647342325718, 33.53363685490181], [-86.61695197187947, 33.5339344853237]], [[-86.61665929597082, 33.53338043234034], [-86.6171669002307, 33.53366106935152]], [[-86.6169119927853, 33.53318330008179], [-86.61737142501678, 33.5334555805154]], [[-86.61712769329297, 33.53295756501159], [-86.61751340261323, 33.53319096097535]], [[-86.61719737258844, 33.53271181476096], [-86.61778382738495, 33.53302459171294]], [[-86.61752430758351, 33.53251620125918], [-86.61801445431303, 33.53276704916448]], [[-86.61773834447528, 33.53223595028696], [-86.61824167402273, 33.5325145014948]], [[-86.61798246796488, 33.53201560632939], [-86.61838475762842, 33.53229145242334]], [[-86.6181743192608, 33.53174642231064], [-86.618579260893, 33.5320680597402]], [[-86.61853073849943, 33.53151470984377], [-86.6189212989964, 33.53186272359854]], [[-86.61890850174466, 33.53131065955328], [-86.61918141439098, 33.53167190607098]], [[-86.61920453296676, 33.53114402738836], [-86.61937576929576, 33.53145746556593]], [[-86.61942444577946, 33.53105943791934], [-86.61964639120474, 33.5313757840002]], [[-86.61993379594036, 33.53098862090357], [-86.61987566833561, 33.53135649020139]], [[-86.62036385849991, 33.53125159978212], [-86.61998109700173, 33.53144664811867]], [[-86.62032839113762, 33.53183246954887], [-86.61982298848444, 33.53153899583192]], [[-86.61995673281635, 33.53203537800564], [-86.61953506314033, 33.5317232539813]], [[-86.61964442490394, 33.53223451816263], [-86.61932363806088, 33.53197241216341]], [[-86.61934206422015, 33.53256106380706], [-86.61905637192397, 33.53231226729647]], [[-86.61909676292174, 33.53273754616175], [-86.61882775161605, 33.53250784770371]], [[-86.61884279014075, 33.53293368977465], [-86.61858300874398, 33.53269900196572]], [[-86.61855556491037, 33.53313537366212], [-86.6183200077645, 33.53290926351823]], [[-86.61832680075707, 33.53337804231456], [-86.61807004254473, 33.53319316535615]], [[-86.6180484978649, 33.53360048622869], [-86.6177364735251, 33.53334697938087]], [[-86.61779599124854, 33.53387041006444], [-86.61742933777553, 33.5336206438603]], [[-86.61761356552879, 33.53418512244896], [-86.61714297059461, 33.53393773550891]], [[-86.61751989184843, 33.53438862683743], [-86.61683843044092, 33.53422691001023]], [[-86.61763875806653, 33.53472138697887], [-86.61684203933844, 33.53466407468822]], [[-86.61759753782692, 33.53498569586905], [-86.61681736733776, 33.53506174175669]], [[-86.61745677792031, 33.53528469318689], [-86.61669301366905, 33.53545907075963]], [[-86.61755228165883, 33.53532520729581], [-86.61697355232835, 33.53595493755699]], [[-86.61758046189237, 33.53538741709435], [-86.61781015814924, 33.5361495259321]], [[-86.61769802461372, 33.53532112745121], [-86.6182561793169, 33.53608773924488]], [[-86.61782470392532, 33.53527979763771], [-86.6186413898435, 33.53573447658979]], [[-86.61799583282854, 33.53522277859548], [-86.61881943329414, 33.53523751085656]], [[-86.61795549189523, 33.53497121678961], [-86.61869440832606, 33.53482800073758]], [[-86.61791927141891, 33.534686482038], [-86.61855047067328, 33.53448587005354]], [[-86.61774105590987, 33.53439576818231], [-86.61838471055654, 33.53424101282785]], [[-86.61776847069213, 33.5338850955535], [-86.61840036006441, 33.53405358673476]], [[-86.61808734643458, 33.53352534655248], [-86.61857128665983, 33.5339397237251]], [[-86.61836647496332, 33.53339024716263], [-86.61873670604828, 33.5337013653383]], [[-86.61855264477255, 33.5331528813059], [-86.61895351881358, 33.53349515012956]], [[-86.61882170775203, 33.53291321213424], [-86.61925869544308, 33.53326659914489]], [[-86.61921112357606, 33.5326692235049], [-86.61953394134143, 33.53295765649452]], [[-86.6194586237611, 33.53250698357889], [-86.61976221375791, 33.53275450668421]], [[-86.61979350570786, 33.53228299547431], [-86.62006642871819, 33.53249065224649]], [[-86.61988974040258, 33.53218202286926], [-86.62031494332652, 33.532299547649]]]

originalState = [StatePosition((i-5)/10, (i-5)/10, i/10) for i in range(50)]
modifiedState1 = [StatePosition((i-5)/8, (i-5)/8, i/10) for i in range(50)]
modifiedState2 = [StatePosition((i-5)/12, (i-5)/12, i/10) for i in range(50)]
modifiedState3 = [StatePosition((-i-5)/12, (-i-5)/12, i/10) for i in range(50)]

# Efficient Intersection Algorithm, taken from https://bryceboe.com/2006/10/23/line-segment-intersection-algorithm/

def ccw(A: list, B: list, C: list):
    '''
    Returns true if 3 points are in clockwise order
    '''
    return (C[1]-A[1])*(B[0]-A[0]) > (B[1]-A[1])*(C[0] - A[0])

def intersect(segment1: list, segment2: list):
    '''
    Returns true if both segments intersect
    '''
    return ccw(segment1[0],segment2[0],segment2[1]) != ccw(segment1[1],segment2[0],segment2[1]) and ccw(segment1[0],segment1[1],segment2[0]) != ccw(segment1[0],segment1[1],segment2[1])


def findIntersection(state: list[StatePosition], gates: list[list]):
    '''
    Finds the gate and time to cross gate if the state crosses a gate in a list of gates
    '''
    initialTime = state[0].time

    for index in range(len(state) - 1):
        point1 = [state[index].x, state[index].y]
        point2 = [state[index + 1].x, state[index + 1].y]
        segment = [point1, point2]

        for gate in gates:
            if intersect(gate, segment):
                intersectedGate = gate
                time = state[index].time - initialTime
                return intersectedGate, time

    return None


def testIntersection(state: list[StatePosition], gate: list):
    initialTime = state[0].time

    for index in range(len(state) - 1):
        point1 = [state[index].x, state[index].y]
        point2 = [state[index + 1].x, state[index + 1].y]
        segment = [point1, point2]

        if intersect(gate, segment):
            time = state[index].time - initialTime
            return time

    return None


def scoreState(originalState: list[StatePosition], modifiedState: list[StatePosition], gates: list[list]): #This might be modified to calculate for a list of modified states because it feels wasteful to recalculated base time every time
    '''
    Returns the time difference to cross a gate between two states
    '''
    intersectedGate, baseTime = findIntersection(originalState, gates)
    modifiedTime = testIntersection(modifiedState, intersectedGate)

    if modifiedTime:
        return modifiedTime - baseTime
    else: return "Never Crosses Gate"


def all_gate_intersections(state: list[StatePosition], gates: list[list]):
    """
    Return a list of (gate_index, time) for all gates crossed by the trajectory.
    Order is based on trajectory time.
    """
    hits = []
    initialTime = state[0].time

    for i in range(len(state) - 1):
        p1 = [state[i].x, state[i].y]
        p2 = [state[i+1].x, state[i+1].y]
        seg = [p1, p2]

        for gi, gate in enumerate(gates):
            if intersect(gate, seg):
                t = state[i].time - initialTime
                hits.append((gi, t))
    return hits

def score_modified_against_baseline(baseline_state, modified_state, gates):
    """
    Compare modified trajectory to baseline using the LAST gate baseline reaches.
    Returns:
        Î”t = modified_time - baseline_time    (negative = improvement)
        or "Never Crosses Gate"
    """
    baseline_hits = all_gate_intersections(baseline_state, gates)

    if len(baseline_hits) == 0:
        return "Baseline never crosses a gate"

    # Last gate baseline intersects
    last_gate_index, baseline_time = baseline_hits[-1]

    # When does modified reach the same gate?
    modified_time = testIntersection(modified_state, gates[last_gate_index])

    if modified_time is None:
        return "Never Crosses Gate"

    return modified_time - baseline_time