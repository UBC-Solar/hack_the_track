services:
  backend:
    build: ./backend
    container_name: fastapi-backend
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - PG_DSN=postgresql://telemetry:telemetry@tickdb:5432/telemetry
      - BROKER=redpanda:9092
    depends_on:
      tickdb:
        condition: service_healthy

  frontend:
    build: ./frontend
    container_name: vite-frontend
    ports:
      - "5173:80"
    depends_on:
      - backend

  redpanda:
    image: redpandadata/redpanda:latest
    command: >
      redpanda start --overprovisioned --smp 1 --memory 1G
        --reserve-memory 0M --check=false --node-id 0
        --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
        --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
    ports:
      - "19092:19092"   # host access
    volumes:
      - type: tmpfs
        target: /var/lib/redpanda/data
        tmpfs:
          size: 1073741824   # 1 GiB (adjust)
          mode: 0777         # <-- allow redpanda user to write
    restart: unless-stopped

  tickdb:
    image: postgres:16
    environment:
      POSTGRES_USER: telemetry
      POSTGRES_PASSWORD: telemetry
      POSTGRES_DB: telemetry
    ports:
      - "5432:5432"              # host access if you want it
    volumes:
      - ./backend/tickdb-init:/docker-entrypoint-initdb.d  # schema init
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U telemetry -d telemetry -h 127.0.0.1 -p 5432" ]
      interval: 2s
      timeout: 2s
      retries: 30
    restart: unless-stopped

  tick-consumer:
    build:
      context: ./backend
      dockerfile: tick-consumer.Dockerfile
    depends_on:
      - redpanda
      - tickdb
    environment:
      BROKER: redpanda:9092
      TOPIC: telem.stream_fast.raw
      GROUP_ID: tick-snapshots
      PG_DSN: postgresql://telemetry:telemetry@tickdb:5432/telemetry
      TICK_TABLE: telem_tick
      TICK_SECS: "0.1"
      WIPE_ON_START: "true"          # do it at consumer startup
      WIPE_TABLES: "telem_tick"      # comma-separated if >1
      CONTROL_TOPIC: tick.control
      CONTROL_TOPIC_CREATE: "true"
      CONTROL_TOPIC_PARTITIONS: "1"
      CONTROL_TOPIC_REPLICATION: "1"
      CONTROL_TOPIC_COMPACT: "true"   # optional: compacted control topic
      BROKER_READY_TIMEOUT_SECS: "45"
    healthcheck:
      # succeed when the broker answers metadata requests
      test: [ "CMD-SHELL", "rpk cluster info --brokers=localhost:9092 >/dev/null 2>&1" ]
      interval: 2s
      timeout: 2s
      retries: 60
    restart: unless-stopped

  adminer:
    image: adminer
    container_name: adminer
    ports:
      - "8080:8080"  # Expose Adminer on port 8080
    environment:
      ADMINER_DEFAULT_SERVER: tickdb  # Set the default PostgreSQL server
    restart: unless-stopped
